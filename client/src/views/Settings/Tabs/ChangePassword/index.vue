<template>
  <q-page class="q-pa-lg">
    <q-form
      class="q-gutter-md"
      @submit="onFormSubmit"
    >
      <q-input
        label="Current password"
        placeholder="Type your current password"
        v-model="formModel.currentPassword"
        :type="isCurrentPassVisible ? 'password' : 'text'"
        :rules="[requiredField]"
      >
        <template v-slot:append>
          <q-icon
            :name="isCurrentPassVisible ? 'visibility_off' : 'visibility'"
            class="cursor-pointer"
            @click="isCurrentPassVisible = !isCurrentPassVisible"
          />
        </template>
      </q-input>
      <q-input
        label="New password"
        placeholder="Type your new password"
        v-model="formModel.newPassword"
        :type="isNewPassVisible ? 'password' : 'text'"
        :rules="[checkPasswordField, requiredField]"
        lazy-rules
      >
        <template v-slot:append>
          <q-icon
            :name="isNewPassVisible ? 'visibility_off' : 'visibility'"
            class="cursor-pointer"
            @click="isNewPassVisible = !isNewPassVisible"
          />
        </template>
      </q-input>
      <q-input
        label="Confirm new password"
        placeholder="Confirm your new password"
        v-model="formModel.confirmNewPassword"
        :type="isConfirmNewPassVisible ? 'password' : 'text'"
        :rules="[checkConfirmPassword, requiredField]"
        lazy-rules
      >
        <template v-slot:append>
          <q-icon
            :name="isConfirmNewPassVisible ? 'visibility_off' : 'visibility'"
            class="cursor-pointer"
            @click="isConfirmNewPassVisible = !isConfirmNewPassVisible"
          />
        </template>
      </q-input>
      <div class="q-pt-md">
        <q-btn
          label="Change password"
          type="submit"
          color="primary"
          no-caps
        />
        <br>
        <q-btn
          label="Forgot password?"
          @click="onForgotPasswordClick"
          color="primary"
          flat
          no-caps
          class="q-mt-md"
        />
      </div>
    </q-form>
  </q-page>
</template>

<script>
import {
  requiredField,
  checkPasswordField,
  checkRepeatPasswordField
} from '@/utilities/validation.js'
import authService from '@/services/auth.js'

export default {
  data () {
    return {
      isCurrentPassVisible: true,
      isNewPassVisible: true,
      isConfirmNewPassVisible: true,
      formModel: {
        currentPassword: '',
        newPassword: '',
        confirmNewPassword: ''
      }
    }
  },

  methods: {
    requiredField,
    checkPasswordField,
    checkConfirmPassword (newval) {
      return checkRepeatPasswordField(newval, this.formModel.newPassword)
    },
    onForgotPasswordClick () {
      this.$router.push({ path: '/forgotpassword' })
    },
    onFormSubmit () {
      authService.changePassword({
        oldpassword: this.formModel.currentPassword,
        newpassword: this.formModel.newPassword
      })
        .then((response) => {
          this.$q.notify({
            color: 'primary',
            textColor: 'white',
            message: 'Your password was changed.',
            actions: [{ icon: 'close', color: 'white' }],
            timeout: 3000
          })
        })
        .catch(err => {
          this.$q.notify({
            color: 'negative',
            textColor: 'white',
            message: err.response.data,
            actions: [{ icon: 'close', color: 'white' }],
            timeout: 3000
          })
        })
    }
  }
}
</script>

<style scoped>
.q-field--with-bottom {
  padding-bottom: 10px;
}
</style>
